<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Índice Kp</title>
    <!-- Paleta de colores basada en la escala oficial NOAA para tormentas geomagnéticas -->
    <style>
        :root {
            --kp-quiet: #43a047;       /* Kp 0‑3 */
            --kp-unsettled: #c0ca33;   /* Kp 4   */
            --kp-g1: #ffeb3b;          /* Kp 5   */
            --kp-g2: #ff9800;          /* Kp 6   */
            --kp-g3: #f44336;          /* Kp 7   */
            --kp-g4g5: #b71c1c;        /* Kp 8‑9 */
            --bg-light: #f4f4f9;
            --text-base: #333;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        body {
            font-family: Arial, sans-serif;
            background: var(--bg-light);
            margin: 0;
            padding: 16px;
            color: var(--text-base);
        }

        h1, h2 { text-align: center; margin: 0 0 1rem; }

        /* Tabla */
        table {
            width: 100%;
            max-width: 920px;
            margin: 0 auto 2rem;
            border-collapse: collapse;
            background: #fff;
            box-shadow: var(--shadow);
        }
        th, td { padding: 0.5rem; text-align: center; border: 1px solid #ddd; }
        th { background: var(--kp-unsettled); color: #fff; }
        tr:nth-child(even) { background: #fafafa; }
        tr:hover { filter: brightness(0.95); }

        /* Panel último valor */
        #tipoTormenta {
            width: 100%;
            max-width: 920px;
            margin: 0 auto 2rem;
            padding: 1rem;
            border-radius: 8px;
            background: #fff;
            box-shadow: var(--shadow);
            font-size: 1.1rem;
            text-align: center;
        }
        #kpValor { font-weight: bold; font-size: 1.4rem; }

        /* Clases de texto */
        .lvl-quiet   { color: var(--kp-quiet); }
        .lvl-unset   { color: var(--kp-unsettled); }
        .lvl-g1      { color: var(--kp-g1); }
        .lvl-g2      { color: var(--kp-g2); }
        .lvl-g3      { color: var(--kp-g3); }
        .lvl-g4g5    { color: var(--kp-g4g5); }

        canvas { display: block; margin: 0 auto 3rem; max-width: 95%; height: 420px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Últimos 20 valores del índice Kp</h1>

    <table id="kpTable">
        <thead>
            <tr>
                <th>Fecha y Hora</th>
                <th>Índice Kp (Real)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="tipoTormenta">
        <p>Último valor del índice Kp: <span id="kpValor"></span></p>
        <p>Tipo de tormenta: <span id="kpTormenta"></span></p>
    </div>

    <h2>Gráfico del Índice Kp</h2>
    <canvas id="kpChart"></canvas>

    <script>
        const url = "https://services.swpc.noaa.gov/json/planetary_k_index_1m.json";
        let chartInstance;

        /* === Utilidades de color y clasificación === */
        const css = k => getComputedStyle(document.documentElement).getPropertyValue(k).trim();

        function colorPorKP(v) {
            if (v >= 8) return css('--kp-g4g5');
            if (v >= 7) return css('--kp-g3');
            if (v >= 6) return css('--kp-g2');
            if (v >= 5) return css('--kp-g1');
            if (v >= 4) return css('--kp-unsettled');
            return css('--kp-quiet');
        }

        function claseTextoPorKP(v) {
            if (v >= 8) return 'lvl-g4g5';
            if (v >= 7) return 'lvl-g3';
            if (v >= 6) return 'lvl-g2';
            if (v >= 5) return 'lvl-g1';
            if (v >= 4) return 'lvl-unset';
            return 'lvl-quiet';
        }

        function determinarTipoTormenta(kp) {
            if (kp >= 8)  return "Tormenta extrema (G4/G5)";
            if (kp >= 7)  return "Tormenta fuerte (G3)";
            if (kp >= 6)  return "Tormenta moderada (G2)";
            if (kp >= 5)  return "Tormenta leve (G1)";
            if (kp >= 4)  return "Condiciones inestables";
            return "Sin tormenta geomagnética significativa";
        }

        /* === Petición de datos === */
        async function obtenerUltimos20KP() {
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.slice(0, 20);
            } catch (err) {
                console.error('Error al obtener los datos del índice Kp:', err);
                return [];
            }
        }

        /* === Renderizado de gráfico === */
        function renderizarGrafico(kpData) {
            const ctx = document.getElementById('kpChart').getContext('2d');
            const labels  = kpData.map(kp => new Date(kp.time_tag).toLocaleString('es-ES', { timeZone: 'Europe/Madrid' })).reverse();
            const valores = kpData.map(kp => kp.estimated_kp).reverse(); // decimales reales
            const colores = kpData.map(kp => colorPorKP(Math.round(kp.estimated_kp))).reverse();

            chartInstance?.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data: valores, backgroundColor: colores }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => `Kp: ${ctx.raw.toFixed(2)}` } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 9,
                            ticks: { stepSize: 1 },
                            title: { display: true, text: 'Valor Kp' },
                            grid: { color: '#e0e0e0' }
                        },
                        x: {
                            ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 20 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        /* === Tabla y panel principal === */
        async function actualizarTabla() {
            const kpData = await obtenerUltimos20KP();
            const tbody  = document.querySelector('#kpTable tbody');
            tbody.innerHTML = '';

            kpData.forEach(k => {
                const fechaTxt = new Date(k.time_tag).toLocaleString('es-ES', { timeZone: 'Europe/Madrid' });
                const kpRaw    = k.estimated_kp;
                const kpRnd    = Math.round(kpRaw);

                const tr = document.createElement('tr');
                tr.style.backgroundColor = colorPorKP(kpRnd) + '33'; // 20 % opacidad

                const tdFecha = document.createElement('td'); tdFecha.textContent = fechaTxt;
                const tdKp    = document.createElement('td'); tdKp.textContent = kpRaw.toFixed(2);

                tr.append(tdFecha, tdKp);
                tbody.appendChild(tr);
            });

            const ultimoRaw = kpData[0]?.estimated_kp ?? 0;
            const ultimoRnd = Math.round(ultimoRaw);

            const kpValor = document.getElementById('kpValor');
            kpValor.textContent = ultimoRaw.toFixed(2);
            kpValor.className = claseTextoPorKP(ultimoRnd);

            const kpTormenta = document.getElementById('kpTormenta');
            kpTormenta.textContent = determinarTipoTormenta(ultimoRnd);
            kpTormenta.className = claseTextoPorKP(ultimoRnd);

            // Renderizamos el gráfico con los nuevos datos
            renderizarGrafico(kpData);
        }

        // Carga inicial y refresco cada minuto
        actualizarTabla();
        setInterval(actualizarTabla, 60000);
    </script>
</body>
</html>
